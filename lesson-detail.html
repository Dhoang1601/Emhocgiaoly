<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="lessonPageTitle">Bài Học</title>
    <link rel="stylesheet" href="style.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    <style>
        /* CSS riêng cho trang lesson-detail.html */
        body {
            background-color: #f0f2f5; /* Nền xám nhạt cho trang học */
            padding-bottom: 80px; /* Đảm bảo có khoảng trống cho thanh điều hướng dưới cùng */
        }
        .lesson-header {
            background-color: #58CC02; /* Màu xanh lá của Duolingo */
            color: white;
            padding: 20px;
            text-align: center;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        .lesson-header h1 {
            margin: 0;
            font-size: 2em;
        }
        .lesson-header p {
            margin: 5px 0 0;
            font-size: 1.1em;
            opacity: 0.9;
        }
        .lesson-content-wrapper { /* Wrapper mới cho nội dung chính */
            padding: 30px;
            max-width: 800px;
            margin: 20px auto 0 auto;
            border-radius: 8px;
        }
        
        /* Ẩn navigation cũ */
        .lesson-navigation {
            display: none;
        }
    </style>
</head>
<body>
    <div class="lesson-header">
        <h1 id="lessonMainTitle"></h1>
        <p id="lessonSubTitle"></p>
    </div>

    <div class="lesson-content-wrapper">
        <div class="progress-bar-container">
            <div class="progress-bar" id="lessonProgressBar"></div>
        </div>
        <div class="lesson-content-area" id="lessonContentArea">
            </div>
    </div>

    <div class="bottom-navigation-bar">
        <div class="feedback-message" id="feedbackMessage"></div>
        <div class="xp-display" id="xpDisplay">+10 XP</div>
        <button class="continue-btn" id="continueButton" disabled>TIẾP TỤC</button>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const lessonPageTitle = document.getElementById('lessonPageTitle');
            const lessonMainTitle = document.getElementById('lessonMainTitle');
            const lessonSubTitle = document.getElementById('lessonSubTitle');
            const lessonContentArea = document.getElementById('lessonContentArea');
            const lessonProgressBar = document.getElementById('lessonProgressBar');
            const continueButton = document.getElementById('continueButton');
            const feedbackMessage = document.getElementById('feedbackMessage');
            const xpDisplay = document.getElementById('xpDisplay');

            // Dữ liệu giả định cho nội dung từng bài học
            const allLessonsContent = {
                'xung-toi': {
                    'xt1': {
                        title: 'Bài 1: Em học giáo lý',
                        sections: [
                            {
                                type: 'word-of-god-display',
                                content: '“Phúc cho kẻ nghe Lời Thiên Chúa và đem ra thực hành” (Lc 11,28)',
                                desc: 'Lời Chúa mời gọi chúng ta lắng nghe và thực hành Lời Người trong đời sống hằng ngày.'
                            },
                            {
                                type: 'multiple-choice',
                                question: 'Mục đích chính của việc học giáo lý là gì?',
                                options: [
                                    { text: 'Để biết nhiều điều', correct: false },
                                    { text: 'Để biết Thiên Chúa là Cha và mọi người là anh chị em', correct: true },
                                    { text: 'Để đi lễ nhà thờ', correct: false },
                                    { text: 'Để được khen ngợi', correct: false }
                                ],
                                feedback_correct: 'Chính xác! Học giáo lý giúp chúng ta hiểu về mối quan hệ của mình với Thiên Chúa và tha nhân.',
                                feedback_incorrect: 'Hãy suy nghĩ lại. Mục đích chính của việc học giáo lý là để biết về Thiên Chúa và mối quan hệ của chúng ta với Người.'
                            },
                            {
                                type: 'fill-in-blank',
                                question_before: 'Khi biết Thiên Chúa là Cha và mọi người là anh chị em, em sẽ làm gì?',
                                blank_start_text: 'Em biết như thế để ',
                                blank_correct_answer: 'mến Chúa, yêu người',
                                blank_end_text: ', cho ngày sau được hưởng phúc đời đời.',
                                hint: 'Hãy nhớ về hành động cần làm khi biết về Chúa và tha nhân.',
                                feedback_correct: 'Tuyệt vời! Chúng ta yêu mến Chúa và yêu thương mọi người.',
                                feedback_incorrect: 'Gần đúng! Hãy nhớ rằng, biết Thiên Chúa là Cha và mọi người là anh chị em giúp chúng ta yêu mến Chúa và yêu thương tha nhân.'
                            },
                            {
                                type: 'summary',
                                title: 'Tóm tắt bài học',
                                content: 'Bài học này giúp chúng ta hiểu rằng học giáo lý không chỉ là tiếp thu kiến thức mà còn là để nhận ra tình yêu của Thiên Chúa và áp dụng vào đời sống, thể hiện qua việc yêu mến Chúa và yêu thương anh chị em.'
                            }
                        ]
                    },
                    'xt2': {
                        title: 'Bài 2: Tội Là Gì?',
                        sections: [
                            { type: 'paragraph', content: 'Tội lỗi là sự bất tuân Lời Chúa, là xa cách tình yêu của Ngài.' },
                            { type: 'paragraph', content: 'Khi phạm tội, chúng ta làm tổn thương mối quan hệ với Thiên Chúa và với anh chị em.' },
                            { type: 'heading3', content: 'Các loại tội' },
                            { type: 'list', items: ['Tội trọng: Cố ý phạm điều răn Chúa trong những việc quan trọng.', 'Tội nhẹ: Phạm điều răn Chúa trong những việc kém quan trọng hoặc không đủ ý thức.'] },
                            { type: 'paragraph', content: 'Hiểu rõ về tội lỗi giúp chúng ta nhận ra sự cần thiết của Bí tích Hòa Giải.' }
                        ]
                    },
                    'xt3': {
                        title: 'Bài 3: Bí Tích Giải Tội',
                        sections: [
                            { type: 'paragraph', content: 'Bí tích Hòa Giải được thực hiện qua việc xưng tội với Linh mục.' },
                            { type: 'paragraph', content: 'Linh mục là người đại diện Chúa để tha thứ tội lỗi cho chúng ta.' },
                            { type: 'heading3', content: 'Các bước xưng tội' },
                            { type: 'list', items: ['Xét mình: Nhớ lại những tội đã phạm.', 'Ăn năn tội.', 'Quyết tâm chừa tội.', 'Xưng tội với Linh mục.', 'Nhận lời khuyên và đền tội.'] },
                            { type: 'paragraph', content: 'Hãy đến với Bí tích thường xuyên để tâm hồn được thanh tẩy.' }
                        ]
                    }
                },
                'them-suc': {
                    'ts1': {
                        title: 'Bài 1: Chúa Thánh Thần',
                        sections: [
                            { type: 'paragraph', content: 'Chúa Thánh Thần là Ngôi Ba Thiên Chúa, Đấng ban sự sống.' },
                            { type: 'paragraph', content: 'Ngài hiện diện và hoạt động trong Hội Thánh và trong mỗi người Kitô hữu.' }
                        ]
                    },
                    'ts2': {
                        title: 'Bài 2: Ân sủng Thánh Thần',
                        sections: [
                            { type: 'paragraph', content: 'Bí tích Thêm Sức ban ân sủng đặc biệt của Chúa Thánh Thần.' },
                            { type: 'paragraph', content: 'Các ân sủng giúp chúng ta sống mạnh mẽ hơn trong đức tin.' }
                        ]
                    },
                    'ts3': {
                        title: 'Bài 3: Nghi thức Thêm Sức',
                        sections: [
                            { type: 'paragraph', content: 'Nghi thức Thêm Sức được cử hành bởi Giám mục.' },
                            { type: 'paragraph', content: 'Chúng ta được xức dầu Thánh và lãnh nhận ấn tín Thánh Thần.' }
                        ]
                    }
                },
                'song-dao': {
                    'sd1': {
                        title: 'Bài 1: Mười Điều Răn',
                        sections: [
                            { type: 'paragraph', content: 'Mười Điều Răn là nền tảng của đời sống luân lý Kitô giáo.' },
                            { type: 'paragraph', content: 'Chúng ta được mời gọi tuân giữ để sống đẹp lòng Chúa.' }
                        ]
                    },
                    'sd2': {
                        title: 'Bài 2: Giữ các Giới răn',
                        sections: [
                            { type: 'paragraph', content: 'Giữ các Giới răn không phải là gánh nặng mà là con đường dẫn đến hạnh phúc.' },
                            { type: 'paragraph', content: 'Thiên Chúa ban Giới răn vì Ngài yêu thương chúng ta.' }
                        ]
                    },
                    'sd3': {
                        title: 'Bài 3: Thực hành Bác ái',
                        sections: [
                            { type: 'paragraph', content: 'Bác ái là giới răn quan trọng nhất, tóm gọn mọi giới răn khác.' },
                            { type: 'paragraph', content: 'Chúng ta thực hành bác ái qua việc yêu thương Thiên Chúa và yêu thương tha nhân.' }
                        ]
                    }
                }
            };

            // Định nghĩa lessonData chính xác (tương tự như trong trangchu.html / hoc.html để lấy tên phần học)
            const globalLessonStructure = {
                'xung-toi': {
                    name: 'Xưng Tội',
                    lessons: [
                        { id: 'xt1', title: 'Bài 1: Thiên Chúa Là Ai?', desc: '' },
                        { id: 'xt2', title: 'Bài 2: Tội Là Gì?', desc: '' },
                        { id: 'xt3', title: 'Bài 3: Bí Tích Giải Tội', desc: '' }
                    ]
                },
                'them-suc': {
                    name: 'Thêm Sức',
                    lessons: [
                        { id: 'ts1', title: 'Bài 1: Chúa Thánh Thần', desc: '' },
                        { id: 'ts2', title: 'Bài 2: Bảy Ơn Chúa Thánh Thần', desc: '' },
                        { id: 'ts3', title: 'Bài 3: Biểu Tượng Chúa Thánh Thần', desc: '' }
                    ]
                },
                'song-dao': {
                    name: 'Sống Đạo',
                    lessons: [
                        { id: 'sd1', title: 'Bài 1: Sống Đức Tin', desc: '' },
                        { id: 'sd2', title: 'Bài 2: Sống Đức Cậy', desc: '' },
                        { id: 'sd3', title: 'Bài 3: Sống Đức Mến', desc: '' }
                    ]
                }
            };

            let currentLessonSections = [];
            let currentSectionIndex = 0;
            let xpGained = 0;

            function updateProgressBar() {
                const progress = ((currentSectionIndex) / currentLessonSections.length) * 100;
                lessonProgressBar.style.width = `${progress}%`;
            }

            function showFeedback(message, isCorrect) {
                feedbackMessage.textContent = message;
                feedbackMessage.classList.remove('correct', 'incorrect');
                feedbackMessage.classList.add(isCorrect ? 'correct' : 'incorrect');
                feedbackMessage.classList.add('show');
                
                if (isCorrect) {
                    xpDisplay.style.display = 'block';
                } else {
                    xpDisplay.style.display = 'none';
                }

                continueButton.disabled = false;
            }

            function hideFeedback() {
                feedbackMessage.classList.remove('show');
                feedbackMessage.textContent = '';
                xpDisplay.style.display = 'none';
            }

            function moveToNextSection() {
                hideFeedback();
                currentSectionIndex++;
                renderCurrentSection();
            }

            function renderCurrentSection() {
                lessonContentArea.innerHTML = '';
                continueButton.disabled = true;

                // Cập nhật thanh tiến trình trước khi render section mới (để nó phản ánh trạng thái SẮP tới)
                updateProgressBar();

                if (currentSectionIndex >= currentLessonSections.length) {
                    lessonContentArea.innerHTML = `
                        <div class="exercise-block summary">
                            <h2>Bài học hoàn thành!</h2>
                            <p>Bạn đã hoàn thành tất cả các phần của bài học này.</p>
                            <p>Tổng XP đạt được: ${xpGained} XP</p>
                        </div>
                    `;
                    continueButton.textContent = "VỀ CON ĐƯỜNG HỌC TẬP";
                    continueButton.disabled = false;
                    continueButton.onclick = () => {
                        window.location.href = `trangchu.html`;
                    };
                    return;
                }

                const section = currentLessonSections[currentSectionIndex];
                const exerciseBlock = document.createElement('div');
                exerciseBlock.classList.add('exercise-block');

                // Xóa mọi onclick cũ trên nút tiếp tục để tránh sự kiện chồng chéo
                continueButton.onclick = null; 

                if (section.type === 'word-of-god-display') {
                    exerciseBlock.classList.add('word-of-god-display');
                    const pContent = document.createElement('p');
                    pContent.textContent = section.content;
                    exerciseBlock.appendChild(pContent);
                    const pDesc = document.createElement('p');
                    pDesc.textContent = section.desc;
                    pDesc.style.fontSize = '0.9em';
                    exerciseBlock.appendChild(pDesc);
                    continueButton.disabled = false;
                    continueButton.onclick = moveToNextSection;
                } else if (section.type === 'multiple-choice') {
                    const h2 = document.createElement('h2');
                    h2.textContent = section.question;
                    exerciseBlock.appendChild(h2);

                    const optionsGrid = document.createElement('div');
                    optionsGrid.classList.add('options-grid');
                    let selectedOption = null; // Biến cục bộ để theo dõi lựa chọn hiện tại

                    section.options.forEach((option, idx) => {
                        const optionCard = document.createElement('div');
                        optionCard.classList.add('option-card');
                        optionCard.textContent = option.text;
                        optionCard.dataset.index = idx;
                        optionCard.addEventListener('click', () => {
                            if (continueButton.onclick === moveToNextSection) return; // Không cho chọn lại sau khi kiểm tra
                            
                            // Xóa lựa chọn cũ
                            if (selectedOption) {
                                selectedOption.classList.remove('selected');
                            }
                            // Chọn lựa chọn mới
                            optionCard.classList.add('selected');
                            selectedOption = optionCard;
                            continueButton.disabled = false;
                            
                            // Gán lại onclick cho nút "TIẾP TỤC" để kiểm tra đáp án
                            continueButton.onclick = () => {
                                if (section.options[parseInt(selectedOption.dataset.index)].correct) {
                                    selectedOption.classList.add('correct');
                                    showFeedback(section.feedback_correct, true);
                                    xpGained += 10;
                                    xpDisplay.textContent = `+10 XP`;
                                } else {
                                    selectedOption.classList.add('incorrect');
                                    const correctOption = optionsGrid.querySelector('.option-card[data-index="' + section.options.findIndex(opt => opt.correct) + '"]');
                                    if (correctOption) correctOption.classList.add('correct');
                                    showFeedback(section.feedback_incorrect, false);
                                }
                                continueButton.onclick = moveToNextSection; // Sau khi kiểm tra, chuyển sang hàm chuyển section
                                optionsGrid.querySelectorAll('.option-card').forEach(card => card.style.pointerEvents = 'none'); // Vô hiệu hóa click
                            };
                        });
                        optionsGrid.appendChild(optionCard);
                    });
                    exerciseBlock.appendChild(optionsGrid);

                } else if (section.type === 'fill-in-blank') {
                    const h2 = document.createElement('h2');
                    h2.textContent = section.question_before;
                    exerciseBlock.appendChild(h2);

                    const blankContainer = document.createElement('div');
                    blankContainer.classList.add('fill-in-blank-container');
                    blankContainer.innerHTML = `${section.blank_start_text}<input type="text" class="fill-in-blank-input" id="blankInput">${section.blank_end_text}`;
                    exerciseBlock.appendChild(blankContainer);

                    const blankInput = document.getElementById('blankInput');
                    // Gán sự kiện cho blankInput ngay sau khi nó được tạo và thêm vào DOM
                    blankInput.addEventListener('input', () => {
                        continueButton.disabled = blankInput.value.trim() === '';
                        if (!continueButton.disabled) { // Bật nút, gán sự kiện kiểm tra
                            continueButton.onclick = () => {
                                const userAnswer = blankInput.value.trim();
                                if (userAnswer) {
                                    if (userAnswer.toLowerCase() === section.blank_correct_answer.toLowerCase()) {
                                        blankInput.style.borderColor = '#28a745';
                                        blankInput.style.color = '#155724';
                                        showFeedback(section.feedback_correct, true);
                                        xpGained += 10;
                                        xpDisplay.textContent = `+10 XP`;
                                    } else {
                                        blankInput.style.borderColor = '#dc3545';
                                        blankInput.style.color = '#721c24';
                                        showFeedback(section.feedback_incorrect, false);
                                    }
                                    blankInput.disabled = true;
                                    continueButton.onclick = moveToNextSection; // Sau khi kiểm tra, chuyển sang hàm chuyển section
                                } else {
                                    alert('Vui lòng điền vào chỗ trống.');
                                }
                            };
                        } else { // Vô hiệu hóa nút, xóa sự kiện kiểm tra
                            continueButton.onclick = null;
                        }
                    });
                    // Đảm bảo nút disabled khi input rỗng lúc ban đầu
                    continueButton.disabled = blankInput.value.trim() === '';

                } else if (section.type === 'summary') {
                    const h2 = document.createElement('h2');
                    h2.textContent = section.title;
                    exerciseBlock.appendChild(h2);
                    const p = document.createElement('p');
                    p.textContent = section.content;
                    exerciseBlock.appendChild(p);
                    continueButton.disabled = false;
                    continueButton.onclick = moveToNextSection;
                } else {
                    // Xử lý các type khác nếu có (paragraph, heading3, list)
                    const h2 = document.createElement('h2');
                    h2.textContent = section.title || 'Nội dung bài học'; // Tiêu đề mặc định
                    exerciseBlock.appendChild(h2);

                    // Render nội dung tùy thuộc vào type
                    if (section.type === 'paragraph') {
                        const p = document.createElement('p');
                        p.textContent = section.content;
                        exerciseBlock.appendChild(p);
                    } else if (section.type === 'heading3') {
                        const h3 = document.createElement('h3');
                        h3.textContent = section.content;
                        exerciseBlock.appendChild(h3);
                    } else if (section.type === 'list') {
                        const ul = document.createElement('ul');
                        section.items.forEach(itemText => {
                            const li = document.createElement('li');
                            li.textContent = itemText;
                            ul.appendChild(li);
                        });
                        exerciseBlock.appendChild(ul);
                    } else {
                         const p = document.createElement('p');
                         p.textContent = 'Loại nội dung không xác định hoặc thiếu: ' + section.type;
                         exerciseBlock.appendChild(p);
                    }
                    continueButton.disabled = false;
                    continueButton.onclick = moveToNextSection;
                }
                
                lessonContentArea.appendChild(exerciseBlock);
            }

            // Khởi tạo bài học
            const urlParams = new URLSearchParams(window.location.search);
            const part = urlParams.get('part');
            const classNum = urlParams.get('class');
            const lessonId = urlParams.get('lesson');

            // --- Console logging để debug ---
            console.log("Loading lesson-detail.html...");
            console.log("Part:", part);
            console.log("Class Num:", classNum);
            console.log("Lesson ID:", lessonId);
            // --- End Console logging ---

            if (part && classNum && lessonId) {
                const partContent = allLessonsContent[part];
                if (partContent) {
                    const currentLesson = partContent[lessonId];
                    if (currentLesson) {
                        const partDisplayName = globalLessonStructure[part]?.name || 'Chưa xác định';
                        lessonPageTitle.textContent = currentLesson.title;
                        lessonMainTitle.textContent = `${partDisplayName} Lớp ${classNum}`;
                        lessonSubTitle.textContent = currentLesson.title;
                        currentLessonSections = currentLesson.sections;

                        // --- Console logging dữ liệu bài học ---
                        console.log("Current Lesson Data:", currentLesson);
                        console.log("Sections to render:", currentLessonSections);
                        // --- End Console logging ---

                        if (currentLessonSections && currentLessonSections.length > 0) {
                             renderCurrentSection(); // Bắt đầu render bài tập đầu tiên
                        } else {
                            lessonContentArea.innerHTML = `<p>Bài học này chưa có nội dung. Vui lòng quay lại.</p>`;
                            continueButton.style.display = 'none';
                        }
                       
                    } else {
                        lessonMainTitle.textContent = "Bài học không tìm thấy";
                        lessonSubTitle.textContent = "";
                        lessonContentArea.innerHTML = `<p>Không tìm thấy nội dung bài học này. Vui lòng quay lại.</p>`;
                        continueButton.style.display = 'none';
                    }
                } else {
                    lessonMainTitle.textContent = "Phần học không tìm thấy";
                    lessonSubTitle.textContent = "";
                    lessonContentArea.innerHTML = `<p>Phần học bạn chọn không hợp lệ. Vui lòng quay lại.</p>`;
                    continueButton.style.display = 'none';
                }
            } else {
                lessonMainTitle.textContent = "Không có bài học được chọn";
                lessonSubTitle.textContent = "";
                lessonContentArea.innerHTML = `<p>Bạn chưa chọn bài học nào. Vui lòng quay lại con đường học tập.</p>`;
                continueButton.style.display = 'none';
            }
        });
    </script>
</body>
</html>